<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Among Us - Strategic Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@7/framework7-bundle.min.css" />
    <style>
        .event-Kill {
            background-color: #ffe6e6;
        }

        .event-Join {
            background-color: #e6ffe6;
        }

        .event-Report {
            background-color: #fffce6;
        }

        th, td {
            font-size: 14px;
            border-bottom: 1px solid #ccc;
            padding: 6px;
        }

        .data-table {
            width: 100%;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Main View -->
        <div class="view view-main view-init">
            <div class="page" data-name="home">
                <div class="navbar"><div class="navbar-inner"><div class="title">Among Us Dashboard</div></div></div>
                <div class="page-content">
                    <div class="block">
                        <p>Enter a session ID to load game data:</p>
                        <div class="list">
                            <ul>
                                <li class="item-content item-input">
                                    <div class="item-inner">
                                        <div class="item-title item-label">Session ID</div>
                                        <div class="item-input-wrap">
                                            <input type="text" placeholder="e.g. abc123" id="session-id" />
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="block">
                            <button class="button button-fill" id="load-btn">Load Session</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page" data-name="session">
                <div class="navbar">
                    <div class="navbar-inner sliding">
                        <div class="left"><a href="#" class="back link"><i class="icon icon-back"></i><span>Back</span></a></div>
                        <div class="title" id="session-title">Session Data</div>
                    </div>
                </div>
                <div class="page-content">
                    <div class="block">
                        <div id="session-table">Loading...</div>
                    </div>
                    <div class="fab fab-right-bottom" id="export-btn">
                        <a href="#"><i class="icon f7-icons">arrow_up_doc</i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/framework7@7/framework7-bundle.min.js"></script>
    <script defer>
        const app = new Framework7({
            root: '#app',
            name: 'Among Us Strategic',
            routes: [
                { path: '/', pageName: 'home' },
                { path: '/session/', pageName: 'session' }
            ]
        });

        let _csvData = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('load-btn').addEventListener('click', async () => {
                const sessionId = document.getElementById('session-id').value.trim();
                if (!sessionId) {
                    app.dialog.alert('Please enter a session ID');
                    return;
                }

                app.views.main.router.navigate('/session/');
                document.getElementById('session-title').textContent = `Session ${sessionId}`;
                document.getElementById('session-table').innerHTML = '<div class="block">Loading data...</div>';

                try {
                    const response = await fetch(`http://localhost:5001/api/strategic/session/${sessionId}/data`);
                    if (!response.ok) throw new Error('Not found');
                    const res = await response.json();

                    const columns = res.columns;
                    const rows = res.data;

                    let html = '<table class="data-table"><thead><tr>';
                    html += columns.map(col => `<th>${col}</th>`).join('');
                    html += '</tr></thead><tbody>';
                    for (const row of rows) {
                        const cls = `event-${row.eventType}`;
                        html += `<tr class="${cls}">` + columns.map(c => `<td>${row[c]}</td>`).join('') + '</tr>';
                    }
                    html += '</tbody></table>';
                    document.getElementById('session-table').innerHTML = html;
                    _csvData = { columns, rows };
                } catch {
                    document.getElementById('session-table').innerHTML = '<div class="block text-color-red">Session not found</div>';
                }
            });

            document.getElementById('export-btn').addEventListener('click', () => {
                if (!_csvData) {
                    app.dialog.alert('No data to export');
                    return;
                }

                const { columns, rows } = _csvData;
                let csv = columns.join(',') + '\n';
                rows.forEach(row => {
                    csv += columns.map(c => `"${row[c]}"`).join(',') + '\n';
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'session.csv';
                a.click();
                URL.revokeObjectURL(url);
            });
        });
    </script>
</body>
</html>
